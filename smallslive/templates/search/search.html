{% extends 'home_new.html' %}
{% load static from staticfiles %}
{% load thumbor_tags %}
{% load i18n %}

{% block homepage_nav_active %}active{% endblock %}

{% block title %}Smalls Jazz Club{% endblock %}

{# TODO Shouldn't be needed here #}
{% block body_class %}home headers-3{% endblock %}

{% block extra_nav %}

{% endblock %}

{% block extra_head %}
  <meta name="description" content="This is the official website for Smalls Jazz Club in Greenwich Village, New York City!">
{% endblock %}

{% block content %}

  {% if not is_artist_bio %}
    <section id="recently-added-section" class="event-stripe">
      <div class="section-title home recently">
        <div class="title1">
          <span id="ra-recently-added-toggle" class="accent-color no-link"> Recently Added</span>  \
          <span id="ra-most-popular-toggle" class="no-link">Most Popular</span>
        </div>
        <span id="most-popular-filter-container" class="select-container hidden">
          <div class="white-border-select home-filter">
            <select id="most-popular-filter">
              <option value="alltime"{% if popular_select == 'alltime' %} selected{% endif %}>All Time</option>
              <option value="week"{% if popular_select == 'week' %} selected{% endif %}>Last week</option>
              <option value="month"{% if popular_select == 'month' %} selected{% endif %}>Last month</option>
              <option value="year"{% if popular_select == 'year' %} selected{% endif %}>This Year</option>
            </select>
          </div>
        </span>
      </div>
      <main id="recently-added-container">
        <div class="slide-btn recently prev"><b class="indicator-icon icon-left-caret"></b></div>
        <div class="slide-btn recently next"><b class="indicator-icon icon-right-caret"></b></div>
        {% include 'events/event_row.html' with events=new_in_archive secondary=True carousel='recently-carousel' %}
      </main>
      <main id="most-popular-container" class="hidden">
        <div class="slide-btn popular prev"><b class="indicator-icon icon-left-caret"></b></div>
        <div class="slide-btn popular next"><b class="indicator-icon icon-right-caret"></b></div>
        {% include 'events/event_row.html' with events=popular_in_archive secondary=True carousel='popular-carousel' %}
      </main>
    </section>
    <section id="most-popular-section" class="event-stripe hidden">
      <div class="section-title home archive">
        <div class="title1">
          <a href="#" id="mp-recently-added-toggle"> Recently Added</a>  \ <a href="#" id="mp-most-popular-toggle" class="accent-color">Most Popular</a>
        </div>
      </div>
    </section>
  {% endif %}

  {% if user.is_authenticated %}
    {% include 'inactive_dialog.html' %}
  {% endif %}
  {% include 'become_a_supporter_dialog.html' %}

  {% if artist_profile %}
    <div class="artist-search-profile-container pad-content">
      {% include 'artists/artist_detail_search.html' with archived=event_results upcoming=upcoming_events %}
    </div>
  {% endif %}

  <div class="search-container search-container-with-tabs pad-content new-archive{% if user.is_superuser %} admin{% endif %}{% if artist_profile%} artist-profile{% endif %}">
    <!-- Tabs for Musicians and Shows -->
    <div class="search-tabs tabs{% if artist_profile %} artist-profile {% endif %}">
      {% if not is_artist_bio %}
        <div class="{% if not is_artist_bio %} active {% endif %}" data-toggle-tab-target="musicians" data-toggle-tab-group="search-results" data-toggle-hide="no">
          <span class="title1">Musicians</span>
        </div>
      {% endif %}
      <div data-toggle-tab-target="archived-shows" data-toggle-tab-group="search-results" data-toggle-hide="no" class="{% if is_artist_bio %}active{% endif %}">
        <span class="title1">Shows</span>
      </div>
    </div>

    <div class="search-wrapper">
      <div class="search-input-wrapper">
        <form class="search-input" action="{% url 'search' %}">
          <input id="desktop-search-bar" name="q" type="text" placeholder="SEARCH BY NAME, INSTRUMENT, EVENT" autocomplete="off" {% if query_term %} value="{{ query_term }}" {% endif %}>
        </form>
        <div class="search-bar-autocomplete-container"></div>
      </div>

      <div class="archive-datepicker-wrapper search-tab-content {% if is_artist_bio %}active{% endif %}" data-toggle-tab="archived-shows" data-toggle-tab-group="search-results">
        <div class="archive-datepicker fixed">
          <div class="datepicker-container hidden">
            <div style="display: flex;">
              <div class="custom-date-picker from">
                <input class="date-picker-text" type="text" placeholder="Select from date" readonly>
              </div>
              <div class="custom-date-picker to">
                <input class="date-picker-text" type="text" placeholder="Select to date" readonly>
              </div>
              <div id="archive-datepicker-apply" class="custom-date-picker-apply white-border-button">
                Apply
              </div>
            </div>
            <div class="datepicker-reset text2 text-grey"><span id="reset-search-datepicker">Reset</span></div>
          </div>
        </div>
      </div>

      {% if not is_artist_bio %}
        <div id="select-instrument-btn" data-toggle-tab="musicians" data-toggle-tab-group="search-results" class="instrument-btn white-border-button caret search-tab-content active" {% if instrument %} data-instrument="{{ instrument }}"{% endif %}>
            {% if instrument %}{{ instrument }}{% else %}Instrument{% endif %}
        </div>

        <div class="white-border-select artist-sort-select spaced search-tab-content active" data-toggle-tab="musicians" data-toggle-tab-group="search-results">
          <select id="artists-sort" class="white-border-button">
            <option value="a2z">A-Z</option>
            <option value="z2a">Z-A</option>
          </select>
        </div>
      {% endif %}
      {% include 'events/archived_filters.html' with default_to_date=default_to_date is_artist_bio=is_artist_bio %}
    </div>

    <!-- Musicians Container -->
    {% if not is_artist_bio %}
      <section id="musicianContent" data-toggle-tab="musicians" class="search-tab-content active search-page" data-toggle-tab-group="search-results">
        <div class="musicians-results">
          <div class="seaction-title-with-search">
            <div class="section-title title1 musicians-results-title">
              {% if artists_blocks %}
                <span id="total-artist" class="accent-color">{{ showing_artist_results }} </span>
                {% if showing_artist_results > 1 %}
                  <span class="static-text">Musicians in the archive</span>
                {% else %}
                  Musician
                {% endif %}
              {% else %}
                No musicians found
              {% endif%}
              <span class="quotation" style="display: {% if not query_term %}none;{% else %}inline{% endif %}">&nbsp;"</span>
              <span class="accent-color" id="musician-search-title">
                {{ query_term }}
              </span>
              <span class="quotation" style="display: {% if not query_term %}none;{% else %}inline{% endif %}">"</span>
            </div>

            {% if event_results %}
              {% include 'events/archived_filters.html' with default_to_date=default_to_date %}
            {% endif %}
          </div>
        </div>
        {% if artists_blocks %}
          {% include 'search/artists.html' %}
        {% endif %}
      </section>
    {% endif %}
    <!-- Shows Container -->
    <section id="search-content" class="search-content {% if is_artist_bio %}active{% endif %}" data-toggle-tab="archived-shows" data-toggle-tab-group="search-results">
      {% include 'events/shows.html' with events=event_results archived=True default_to_date=default_to_date secondary=True %}
    </section>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    $(document).ready(function () {

      /* Functionality for switching between recently added and most popular
         This has been changed many times. Leaving the code here for convenience
         until there is a final decision */

      initializeRecentlyCarousel();

      function setTextEllipsisClass(tabName) {
        /* The unselected tab text will be trimmed on mobile */

        var $recentlyAdded = $("#ra-recently-added-toggle");
        var $section = $recentlyAdded.closest(".section-title");
        var $mostPopular = $("#ra-most-popular-toggle");
        if (tabName == "popular") {
          if (!$recentlyAdded.hasClass("trim")) {
            $recentlyAdded.addClass("trim");
            if (!$section.hasClass("trim")) {
              $section.addClass("trim");
            }
          }
        } else {
          $recentlyAdded.removeClass("trim");
          $section.removeClass("trim");
        }

      }

      $('#ra-most-popular-toggle').click(function (event) {
        if (!$(this).hasClass("accent-color")) {
          $(this).addClass("accent-color");
        }
        $('#ra-recently-added-toggle').removeClass("accent-color");
        $('#recently-added-container').addClass('hidden');
        $('#most-popular-container').removeClass('hidden');
        $('#most-popular-filter-container').removeClass('hidden');
        initializePopularCarousel();
        setTextEllipsisClass("popular");
      });

      $('#ra-recently-added-toggle').click(function (event) {
        event.preventDefault();
        if (!$(this).hasClass("accent-color")) {
          $(this).addClass("accent-color");
        }
        $('#ra-most-popular-toggle').removeClass("accent-color");
        $('#recently-added-container').removeClass('hidden');
        $('#most-popular-container').addClass('hidden');
        $('#most-popular-filter-container').addClass('hidden');
        initializeRecentlyCarousel();
        setTextEllipsisClass("recently");
      });

      var popularFilterDefaultValue = "{{ popular_select }}";
      var popularQueryUrl = "{% url 'event_popular_ajax' %}";

      var $filter = $("#most-popular-filter");

      var setMostPopular = function(value) {
        var mostPopularFilter = $("#most-popular-container").find(".event-row");
        $.get(popularQueryUrl + "?range=" + value, function(data) {
          mostPopularFilter.hide()
          mostPopularFilter.replaceWith(data);
          initializePopularCarousel();
          mostPopularFilter.show();
        });
      };

      $filter.on("change", function() {
        setMostPopular($filter.val());
        console.log('ko mama!');
      });

    });
  </script>

  <script>
    var defaultFromDate = new Date("{{  first_event_date }}");
    var defaultToDate = new Date("{{ last_event_date }}");
    var eventOrderFilter = 'newest';

    var datePickerFromDate = defaultFromDate;
    var datePickerToDate = defaultToDate;

    var setFromDate = false;
    var setToDate = true;
    var datePickerLeft = 45;
    var datePickerTop = 38;

    var $datePickerFrom = $(".archive-datepicker.fixed .custom-date-picker.from input");
    var $datePickerTo= $(".archive-datepicker.fixed .custom-date-picker.to input");
    var startDate = "{{ first_event_date }}";
    var endDate = "{{ last_event_date }}";
    var venue = "all";
    var moreArtists = true;

    {% if showing_event_results == '0' %}
      var moreEvents = false;
    {% else %}
      var moreEvents = true;
    {% endif %}

    $(document).ready(function () {

      setTimeout(function() {
        $('.search-wrapper .datepicker-container').removeClass('active hidden');
      }, 100);
      $(document).on('click', function(event) {
        var target = $(event.target);
        var parentElement = $('.search-wrapper .archive-datepicker-wrapper');
        var innerElement = $('.search-wrapper .datepicker-container');

        if (target.is(parentElement) || parentElement.has(target).length) {
          innerElement.addClass('active');
        } else {
          innerElement.removeClass('active');
        }
      });

      initializeArchiveDatePickers();
      initializeSearch();
      $("footer.footer-info").removeClass("active");

      loadingEvents = false;
      $(window).scroll(function () {
        if ($(window).scrollTop() >= $(document).height() - $(window).height() - 200) {
          /* if artists are visible and is mobile (flex-wrap is set) */
          /* desktop loads more with slide buttons */

          var $musiciansContent = $("#musicianContent");
          if ($musiciansContent.is(":visible") && $musiciansContent.find(".event-row").css("flex-wrap") == "wrap") {
            searchMoreArtists();
          }

          /* if events are visible always load */
          if ($("#search-content").is(":visible") && moreEvents && !loadingEvents) {
            loadingEvents = true;
            //loadMoreEvents('Archived');
            $('.shows-show-more').click(function() {
              loadMoreEvents('Archived');
            });
            $('.shows-show-more-wrapper').show();
          }
        };
      });

      console.log(loadingEvents);
      if(loadingEvents) {
        $('.shows-show-more-wrapper').show();
      } else {
        $('.shows-show-more-wrapper').hide();
      }

    });

    (function ($) {
      $.each(['show', 'hide'], function (i, ev) {
        var el = $.fn[ev];
        $.fn[ev] = function () {
          this.trigger(ev);
          return el.apply(this, arguments);
        };
      });
    })(jQuery);

  </script>
  <script src="{% static 'js/moment.min.js' %}"></script>
  <script src="{% static 'js/bootstrap-datepicker.js' %}"></script>
  <script src="{% static 'js/tabs.js' %}"></script>
  <script src="{% static 'js/search/search.js' %}"></script>
  <script src="{% static 'js/search/search_datepickers.js' %}"></script>
  <script src="{% static 'js/search/artist_index.js' %}"></script>
  <script src="{% static 'js/slider.js' %}"></script>
{% endblock %}
